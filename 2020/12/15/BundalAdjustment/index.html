<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.2.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.1/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><script class="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"elkulas.github.io",root:"/",images:"/images",scheme:"Pisces",version:"8.1.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12},copycode:!0,bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!0,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"fadeInDown",post_body:"fadeInDown",coll_header:"fadeInLeft",sidebar:"fadeInUp"}},prism:!1,i18n:{placeholder:"搜索...",empty:"没有找到任何搜索结果：${query}",hits_time:"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）",hits:"找到 ${hits} 个搜索结果"}}</script><meta name="description" content="重新记录一下BA的一些思考与细节"><meta property="og:type" content="article"><meta property="og:title" content="再谈Bundle Adjustment"><meta property="og:url" content="https://elkulas.github.io/2020/12/15/BundalAdjustment/index.html"><meta property="og:site_name" content="Elku&#39;s Homepage"><meta property="og:description" content="重新记录一下BA的一些思考与细节"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://elkulas.github.io/2020/12/15/BundalAdjustment/Screenshot%20from%202020-12-15%2013-10-55.png"><meta property="og:image" content="https://elkulas.github.io/2020/12/15/BundalAdjustment/Screenshot%20from%202020-12-15%2013-53-42.png"><meta property="og:image" content="https://elkulas.github.io/2020/12/15/BundalAdjustment/Screenshot%20from%202020-12-15%2013-57-42.png"><meta property="og:image" content="https://elkulas.github.io/2020/12/15/BundalAdjustment/Screenshot%20from%202020-12-15%2014-08-55.png"><meta property="article:published_time" content="2020-12-15T04:52:28.000Z"><meta property="article:modified_time" content="2020-12-15T07:42:49.000Z"><meta property="article:author" content="Elkulas Jiang"><meta property="article:tag" content="原理"><meta property="article:tag" content="算法"><meta property="article:tag" content="SLAM"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://elkulas.github.io/2020/12/15/BundalAdjustment/Screenshot%20from%202020-12-15%2013-10-55.png"><link rel="canonical" href="https://elkulas.github.io/2020/12/15/BundalAdjustment/"><script class="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>再谈Bundle Adjustment | Elku's Homepage</title><noscript><style>body{margin-top:2rem}.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header,.use-motion .sidebar{visibility:visible}.use-motion .footer,.use-motion .header,.use-motion .site-brand-container .toggle{opacity:initial}.use-motion .custom-logo-image,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line{transform:scaleX(1)}.search-pop-overlay,.sidebar-nav{display:none}.sidebar-panel{display:block}</style></noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">Elku's Homepage</h1><i class="logo-line"></i></a></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li></ul></nav></div><div class="toggle sidebar-toggle"><span class="toggle-line"></span> <span class="toggle-line"></span> <span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc">文章目录</li><li class="sidebar-nav-overview">站点概览</li></ul><div class="sidebar-panel-container"><section class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B%E4%B8%AD%E4%BF%A1%E6%81%AF%E7%9F%A9%E9%98%B5%E7%9A%84%E7%BB%84%E6%88%90"><span class="nav-number">1.</span> <span class="nav-text">前言,优化过程中信息矩阵的组成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%B9%E8%A7%86%E8%A7%89ba%E7%9A%84%E7%90%86%E8%A7%A3"><span class="nav-number">2.</span> <span class="nav-text">对视觉BA的理解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81"><span class="nav-number">3.</span> <span class="nav-text">代码</span></a></li></ol></div></section><section class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" alt="Elkulas Jiang" src="/images/shinai2.png"><p class="site-author-name" itemprop="name">Elkulas Jiang</p><div class="site-description" itemprop="description"></div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">56</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/"><span class="site-state-item-count">20</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/"><span class="site-state-item-count">30</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/Elkulas" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Elkulas" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a> </span><span class="links-of-author-item"><a href="mailto:elkulasjiang@gmail.com" title="E-Mail → mailto:elkulasjiang@gmail.com" rel="noopener" target="_blank"><i class="envelope fa-fw"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://weibo.com/2405601891" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;2405601891" rel="noopener" target="_blank"><i class="weibo fa-fw"></i>Weibo</a> </span><span class="links-of-author-item"><a href="https://twitter.com/Elkulas" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;Elkulas" rel="noopener" target="_blank"><i class="twitter fa-fw"></i>Twitter</a></span></div></section></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://elkulas.github.io/2020/12/15/BundalAdjustment/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/shinai2.png"><meta itemprop="name" content="Elkulas Jiang"><meta itemprop="description" content=""></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Elku's Homepage"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">再谈Bundle Adjustment</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建时间：2020-12-15 12:52:28 / 修改时间：15:42:49" itemprop="dateCreated datePublished" datetime="2020-12-15T12:52:28+08:00">2020-12-15</time> </span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/SLAM/" itemprop="url" rel="index"><span itemprop="name">SLAM</span></a></span></span></div><div class="post-description">重新记录一下BA的一些思考与细节</div></div></header><div class="post-body" itemprop="articleBody"><p>BA这个事情感觉自己总是反反复复在看,然后反反复复的忘掉,昨天感觉自己比较大彻大悟,所以今天写一点东西来记一下</p><h2 id="前言优化过程中信息矩阵的组成">前言,优化过程中信息矩阵的组成</h2><p>再讲实际的BA之前,先讲一讲抽象的一个例子,也就是一个图优化的简单例子.用这个例子来更直观的去看优化过程中信息矩阵<span class="math inline">\(H\)</span>的组成.</p><p>对于以下最小二乘优化系统,其对应的图模型也如下图所示</p><p><img src="Screenshot%20from%202020-12-15%2013-10-55.png"> <span class="math display">\[ \boldsymbol{\xi}=\underset{\boldsymbol{\xi}}{\operatorname{argmin}} \frac{1}{2} \sum_{i}\left\|\mathbf{r}_{i}\right\|_{\boldsymbol{\Sigma}_{i}}^{2} \]</span> 其中对于该最小二乘系统<strong>,<span class="math inline">\(\xi\)</span>表示不同的状态量,<span class="math inline">\(r\)</span>表示相关状态量之间获得的误差项</strong></p><p>对于图而言,<strong>圆圈</strong>表示顶点,也就是各个待估计的状态变量<span class="math inline">\(\xi\)</span>,<strong>边</strong>表示状态量之间构建的残差,或者说因为状态量的影响所产生的残差项<span class="math inline">\(r\)</span> <span class="math display">\[ \boldsymbol{\xi}=\left[\begin{array}{c} \boldsymbol{\xi}_{1} \\ \boldsymbol{\xi}_{2} \\ \ldots \\ \boldsymbol{\xi}_{6} \end{array}\right], \mathbf{r}=\left[\begin{array}{l} \mathbf{r}_{12} \\ \mathbf{r}_{13} \\ \mathbf{r}_{14} \\ \mathbf{r}_{15} \\ \mathbf{r}_{56} \end{array}\right] \]</span> 对于上述的最小二乘问题,所获得的高斯牛顿求解方式为: <span class="math display">\[ \underbrace{\mathbf{J}^{\top} \boldsymbol{\Sigma}^{-1} \mathbf{J}}_{\mathbf{H} \text { or } \mathbf{\Lambda}} \delta \boldsymbol{\xi}=\underbrace{-\mathbf{J}^{\top} \boldsymbol{\Sigma}^{-1} \mathbf{r}}_{\mathbf{b}} \]</span> (对于二小二乘优化问题逃不掉这个方程解)</p><p>这里要着重关注雅克比矩阵<span class="math inline">\(J\)</span>,方程左边是优化变量状态量的增量,右边是所获得的误差项,所以这边的雅克比就是解释误差项和状态变量之间的关联程度</p><p>因此,就可以理解,此处的雅克比矩阵为:</p><p><span class="math display">\[ \mathbf{J}=\frac{\partial \mathbf{r}}{\partial \boldsymbol{\xi}} \]</span> 将误差项全部拆写开可以得到 <span class="math display">\[ \mathbf{J}=\frac{\partial \mathbf{r}}{\partial \boldsymbol{\xi}}=\left[\begin{array}{l} \frac{\partial \mathbf{r}_{12}}{\partial \boldsymbol{\xi}} \\ \frac{\partial \mathbf{r}_{13}}{\partial \boldsymbol{\xi}} \\ \frac{\partial \mathbf{r}_{14}}{\partial \boldsymbol{\xi}} \\ \frac{\partial \mathbf{r}_{15}}{\partial \boldsymbol{\xi}} \\ \frac{\partial \mathbf{r}_{56}}{\partial \boldsymbol{\xi}} \end{array}\right]=\left[\begin{array}{l} \mathbf{J}_{1} \\ \mathbf{J}_{2} \\ \mathbf{J}_{3} \\ \mathbf{J}_{4} \\ \mathbf{J}_{5} \end{array}\right], \mathbf{J}^{\top}=\left[\begin{array}{lllll} \mathbf{J}_{1}^{\top} &amp; \mathbf{J}_{2}^{\top} &amp; \mathbf{J}_{3}^{\top} &amp; \mathbf{J}_{4}^{\top} &amp; \mathbf{J}_{5}^{\top} \end{array}\right] \]</span> 因此,高斯牛顿方程可以写成累加的形式 <span class="math display">\[ \sum_{i=1}^{5} \mathbf{J}_{i}^{\top} \boldsymbol{\Sigma}_{i}^{-1} \mathbf{J}_{i} \delta \boldsymbol{\xi}=-\sum_{i=1}^{5} \mathbf{J}^{\top} \boldsymbol{\Sigma}_{i}^{-1} \mathbf{r} \]</span> 这么做本质上其实就是在还原代码实现的过程.</p><p>如果仔细去看代码就可以发现,在求解雅克比的过程中,也是先按照误差,然后再按照状态进行循环,从而将信息矩阵进行填充.</p><p>这里不妨以<span class="math inline">\(J_2\)</span>为例子,将<span class="math inline">\(J_2\)</span>写出来就是 <span class="math display">\[ \mathbf{J}_{2}=\frac{\partial \mathbf{r}_{13}}{\partial \boldsymbol{\xi}}=\left[\begin{array}{llllll} \frac{\partial \mathbf{r}_{13}}{\partial \boldsymbol{\xi}_{1}} &amp; \mathbf{0} &amp; \frac{\partial \mathbf{r}_{13}}{\partial \xi_{3}} &amp; \mathbf{0} &amp; \mathbf{0} &amp; \mathbf{0} \end{array}\right] \]</span> 也就是说,分别包含了状态变量13之间的误差分别对状态1和3做的偏导</p><p>如果误差项是2维,<span class="math inline">\(\xi_1\)</span>是6维,那么第一项就是2x6的一个矩阵块,<span class="math inline">\(\xi_2\)</span>是三维,那么第二项就是2x3的矩阵块</p><p>写成二次型的形式也就是信息矩阵的形式便如下 <span class="math display">\[ \boldsymbol{\Lambda}_{2}=\mathbf{J}_{2}^{\top} \boldsymbol{\Sigma}_{2}^{-1} \mathbf{J} = \left[\begin{array}{ccccc} \left(\frac{\partial \mathbf{r}_{13}}{\partial \xi_{1}}\right)^{\top} \boldsymbol{\Sigma}_{2}^{-1} \frac{\partial \mathbf{r}_{13}}{\partial \xi_{1}} &amp; \mathbf{0} &amp; \left(\frac{\partial \mathbf{r}_{13}}{\partial \xi_{1}}\right)^{\top} \boldsymbol{\Sigma}_{2}^{-1} \frac{\partial \mathbf{r}_{13}}{\partial \xi_{3}} &amp; \mathbf{0} &amp; \mathbf{0} \\ \mathbf{0} &amp; \mathbf{0} &amp; \mathbf{0} &amp; \mathbf{0} &amp; \mathbf{0} \\ \left(\frac{\partial \mathbf{r}_{13}}{\partial \xi_{3}}\right)^{\top} \mathbf{\Sigma}_{2}^{-1} \frac{\partial \mathbf{r}_{13}}{\partial \xi_{1}} &amp; \mathbf{0} &amp; \left(\frac{\partial \mathbf{r}_{13}}{\partial \xi_{3}}\right)^{\top} \boldsymbol{\Sigma}_{2}^{-1} \frac{\partial \mathbf{r}_{13}}{\partial \xi_{3}} &amp; \mathbf{0} &amp; \mathbf{0} \\ \mathbf{0} &amp; \mathbf{0} &amp; \mathbf{0} &amp; \mathbf{0} &amp; \mathbf{0} \\ \mathbf{0} &amp; \mathbf{0} &amp; \mathbf{0} &amp; \mathbf{0} &amp; \mathbf{0} \end{array}\right] \]</span> 继续使用之前的假设,那么第一个矩阵块就是6x6维度,第二个矩阵块就是6x3的维度,第三个矩阵块就是3x6的维度,第四个就是3x3的维度</p><p>每一个误差项的信息矩阵都可以写出来,然后进行累加就可以得到最后的信息矩阵<span class="math inline">\(\Lambda\)</span></p><p><img src="Screenshot from 2020-12-15 13-53-42.png" style="zoom:50%"></p><p>虽然说图上画的是一个小方格,但是实际上是这样的</p><p><img src="Screenshot from 2020-12-15 13-57-42.png" style="zoom:50%"></p><p>所以,状态量维度的变化就会改变每个小方格的维度</p><h2 id="对视觉ba的理解">对视觉BA的理解</h2><p>至此,回到视觉BA</p><p><img src="Screenshot%20from%202020-12-15%2014-08-55.png"></p><p>计算机视觉或者说SLAM问题中的最小二乘优化问题,简单来说就是</p><ol type="1"><li>我要优化的是什么变量,什么状态量</li><li>待优化变量发生变化之后会对什么误差量产生影响</li></ol><p>在诸多的书籍以及博客中其实对上面两个问题都有过解释,也就是</p><ol type="1"><li>在SLAM问题中,待优化的变量是<strong>每一帧相机的位姿</strong>(6维)以及<strong>路标点landmark的位置</strong>(3维).</li><li>各个状态量发生变化之后产生的直观表现就是在<strong>二维图像上的重投影误差</strong>(2维)的改变.</li><li>老生常谈,该最小问题有其特殊性也就是,路标点之间没有关联,所以两个路标点不会对图像重投影误差产生影响.</li></ol><p>所以,这里很重要的一点就是,<strong>各个状态量在优化过程中发生变化,其直观的表现就是在重投影误差上的变化</strong></p><p>这个很重要,感觉理解之后就很舒坦了</p><p>因此,我们需要找到的就是<strong>重投影误差对于各个状态量之间的雅克比</strong>,这边的雅克比简单来说就是去找到一种关系,也就是<strong>坐标点发生微小变化之后观测值(重投影误差)会怎么变</strong>,<strong>相机位姿发生微小变化之后观测值会怎么变</strong>, 雅克比矩阵就是阐述了这种变化的关系.因为各个变量之间的关系常常是非线性的,因此在这个过程中需要进行线性化处理,所以务必要关注<strong>是在哪个时刻哪个位置进行线性化的,线性化的工作点在哪</strong>.</p><p>那么,所要求解的就是两个雅克比,这里借用一下视觉SLAM十四讲的结论 P167</p><p>使用相机的投影模型可以得到<strong>变换到相机坐标系下三维坐标点到二维平面uv的雅克比</strong>(2x3)</p><p>P表示世界坐标系下的值,P'表示变换到当前相机系下的值 <span class="math display">\[ \boldsymbol{P}^{\prime}=\left(\exp \left(\boldsymbol{\xi}^{\wedge}\right) \boldsymbol{P}\right)_{1: 3} \]</span></p><p><span class="math display">\[ u=f_{x} \frac{X^{\prime}}{Z^{\prime}}+c_{x}, \quad v=f_{y} \frac{Y^{\prime}}{Z^{\prime}}+c_{y} \]</span></p><p><span class="math display">\[ \frac{\partial \boldsymbol{r}}{\partial \boldsymbol{P}^{\prime}}=-\left[\begin{array}{ccc} \frac{\partial u}{\partial X^{\prime}} &amp; \frac{\partial u}{\partial Y^{\prime}} &amp; \frac{\partial u}{\partial Z^{\prime}} \\ \frac{\partial v}{\partial X^{\prime}} &amp; \frac{\partial v}{\partial Y^{\prime}} &amp; \frac{\partial v}{\partial Z^{\prime}} \end{array}\right]=-\left[\begin{array}{ccc} \frac{f_{x}}{Z^{\prime}} &amp; 0 &amp; -\frac{f_{x} X^{\prime}}{Z^{\prime 2}} \\ 0 &amp; \frac{f_{y}}{Z^{\prime}} &amp; -\frac{f_{y} Y^{\prime}}{Z^{\prime 2}} \end{array}\right] \]</span></p><p>而第二项就是<strong>重投影误差和位姿之间的雅克比</strong>(2x6),这个可以用两步来求解,首先得到<strong>变换到当前相机位姿坐标系下的三维点对当前相机位姿的雅克比</strong>(3x6) <span class="math display">\[ \frac{\partial \boldsymbol{P}^{\prime}}{\partial \delta \boldsymbol{\xi}}=\left[\boldsymbol{I},-\boldsymbol{P}^{\prime \wedge } \right] \]</span> 然后和之前求得的<strong>变换到相机坐标系下三维坐标点到二维平面uv的雅克比</strong>(2x3)相乘,就可以得到最后的结果(2x6) <span class="math display">\[ \frac{\partial \boldsymbol{r}}{\partial \delta \boldsymbol{\xi}}=-\left[\begin{array}{ccccc} \frac{f_{x}}{Z^{\prime}} &amp; 0 &amp; -\frac{f_{x} X^{\prime}}{Z^{\prime 2}} &amp; -\frac{f_{x} X^{\prime} Y^{\prime}}{Z^{\prime 2}} &amp; f_{x}+\frac{f_{x} X^{2}}{Z^{\prime 2}} &amp; -\frac{f_{x} Y^{\prime}}{Z^{\prime}} \\ 0 &amp; \frac{f_{y}}{Z^{\prime}} &amp; -\frac{f_{y} Y^{\prime}}{Z^{\prime 2}} &amp; -f_{y}-\frac{f_{y} Y^{\prime 2}}{Z^{\prime 2}} &amp; \frac{f_{y} X^{\prime} Y^{\prime}}{Z^{\prime 2}} &amp; \frac{f_{y} X^{\prime}}{Z^{\prime}} \end{array}\right] \]</span> 而对于重投影误差对空间点P的倒数,也可以使用链式法则进行求解(2x3)</p><p>注意,这边所计算的是误差杜绝世界坐标系下的点P的导数</p><p>(<strong>所以为什么要用世界坐标系下的导数呢</strong>) <span class="math display">\[ \frac{\partial \boldsymbol{r}}{\partial \boldsymbol{P}}=\frac{\partial \boldsymbol{r}}{\partial \boldsymbol{P}^{\prime}} \frac{\partial \boldsymbol{P}^{\prime}}{\partial \boldsymbol{P}} \]</span></p><p><span class="math display">\[ \boldsymbol{P}^{\prime}=\exp \left(\boldsymbol{\xi}^{\wedge}\right) \boldsymbol{P}=\boldsymbol{R} \boldsymbol{P}+\boldsymbol{t} \]</span></p><p><span class="math display">\[ \frac{\partial \boldsymbol{r}}{\partial \boldsymbol{P}}=-\left[\begin{array}{ccc} \frac{f_{x}}{Z^{\prime}} &amp; 0 &amp; -\frac{f_{x} X^{\prime}}{Z^{\prime 2}} \\ 0 &amp; \frac{f_{y}}{Z^{\prime}} &amp; -\frac{f_{y} Y^{\prime}}{Z^{\prime 2}} \end{array}\right] \boldsymbol{R} \]</span></p><h2 id="代码">代码</h2><p>这里简单看一下一部分代码</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">	<span class="built_in">std</span>::default_random_engine generator;</span><br><span class="line">   <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Eigen::Vector3d&gt; points;</span><br><span class="line"><span class="comment">// featurenum就是所有路标点的数目</span></span><br><span class="line"><span class="comment">// 进行每一个三维点状态量的循环</span></span><br><span class="line">   <span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; featureNums; ++j)</span><br><span class="line">   &#123;</span><br><span class="line">       <span class="comment">// 此处进行随机点的生成</span></span><br><span class="line">       <span class="function"><span class="built_in">std</span>::uniform_real_distribution&lt;<span class="keyword">double</span>&gt; <span class="title">xy_rand</span><span class="params">(<span class="number">-4</span>, <span class="number">4.0</span>)</span></span>;</span><br><span class="line">       <span class="function"><span class="built_in">std</span>::uniform_real_distribution&lt;<span class="keyword">double</span>&gt; <span class="title">z_rand</span><span class="params">(<span class="number">8.</span>, <span class="number">10.</span>)</span></span>;</span><br><span class="line">       <span class="keyword">double</span> tx = xy_rand(generator);</span><br><span class="line">       <span class="keyword">double</span> ty = xy_rand(generator);</span><br><span class="line">       <span class="keyword">double</span> tz = z_rand(generator);</span><br><span class="line">	<span class="comment">// 获得点的表示形式</span></span><br><span class="line">       <span class="function">Eigen::Vector3d <span class="title">Pw</span><span class="params">(tx, ty, tz)</span></span>;</span><br><span class="line">       points.push_back(Pw);</span><br><span class="line">	<span class="comment">// 进行每一个位姿状态量的循环</span></span><br><span class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; poseNums; ++i) &#123;</span><br><span class="line">           <span class="comment">// 获得当前的位姿</span></span><br><span class="line">           Eigen::Matrix3d Rcw = camera_pose[i].Rwc.transpose();</span><br><span class="line">           <span class="comment">// 获得该位姿坐标系下的点的坐标</span></span><br><span class="line">           Eigen::Vector3d Pc = Rcw * (Pw - camera_pose[i].twc);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">double</span> x = Pc.x();</span><br><span class="line">           <span class="keyword">double</span> y = Pc.y();</span><br><span class="line">           <span class="keyword">double</span> z = Pc.z();</span><br><span class="line">           <span class="keyword">double</span> z_2 = z * z;</span><br><span class="line">           </span><br><span class="line">           Eigen::Matrix&lt;<span class="keyword">double</span>,<span class="number">2</span>,<span class="number">3</span>&gt; jacobian_uv_Pc;</span><br><span class="line">           jacobian_uv_Pc&lt;&lt; fx/z, <span class="number">0</span> , -x * fx/z_2,</span><br><span class="line">                   <span class="number">0</span>, fy/z, -y * fy/z_2;</span><br><span class="line">           <span class="comment">// 误差对于点(三自由度)的雅克比</span></span><br><span class="line">           Eigen::Matrix&lt;<span class="keyword">double</span>,<span class="number">2</span>,<span class="number">3</span>&gt; jacobian_Pj = jacobian_uv_Pc * Rcw;</span><br><span class="line">           <span class="comment">// 误差对于位姿(六自由度)的雅克比</span></span><br><span class="line">           Eigen::Matrix&lt;<span class="keyword">double</span>,<span class="number">2</span>,<span class="number">6</span>&gt; jacobian_Ti;</span><br><span class="line">           jacobian_Ti &lt;&lt; -x* y * fx/z_2, (<span class="number">1</span>+ x*x/z_2)*fx, -y/z*fx, fx/z, <span class="number">0</span> , -x * fx/z_2,</span><br><span class="line">                           -(<span class="number">1</span>+y*y/z_2)*fy, x*y/z_2 * fy, x/z * fy, <span class="number">0</span>,fy/z, -y * fy/z_2;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// 每一个元素进行遍历填写</span></span><br><span class="line">           <span class="comment">// 这里的6x6本质上就是代表了之前格子里画的一小格</span></span><br><span class="line">           <span class="comment">// 位姿对位姿的雅克比填写</span></span><br><span class="line">           H.block(i*<span class="number">6</span>,i*<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>) += jacobian_Ti.transpose() * jacobian_Ti;</span><br><span class="line">           <span class="comment">// 路标点对路标点的雅克比填写</span></span><br><span class="line">           H.block(j*<span class="number">3</span> + <span class="number">6</span>*poseNums,j*<span class="number">3</span> + <span class="number">6</span>*poseNums,<span class="number">3</span>,<span class="number">3</span>) += jacobian_Pj.transpose() * jacobian_Pj;</span><br><span class="line">           <span class="comment">// 位姿对路标点的雅克比填写</span></span><br><span class="line">           H.block(i*<span class="number">6</span>,j*<span class="number">3</span> + <span class="number">6</span>*poseNums, <span class="number">6</span>,<span class="number">3</span>) += jacobian_Ti.transpose() * jacobian_Pj;</span><br><span class="line">           <span class="comment">// 路标点对位姿的雅克比填写</span></span><br><span class="line">           H.block(j*<span class="number">3</span> + <span class="number">6</span>*poseNums,i*<span class="number">6</span> , <span class="number">3</span>,<span class="number">6</span>) += jacobian_Pj.transpose() * jacobian_Ti;</span><br><span class="line">       &#125; <span class="comment">// 位姿循环</span></span><br><span class="line">   &#125; <span class="comment">// 特征点循环</span></span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="post-tags"><a href="/tags/%E5%8E%9F%E7%90%86/" rel="tag"># 原理</a> <a href="/tags/%E7%AE%97%E6%B3%95/" rel="tag"># 算法</a> <a href="/tags/SLAM/" rel="tag"># SLAM</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2020/12/11/Gaussian-inference/" rel="prev" title="高斯推断 Gaussian inference"><i class="fa fa-chevron-left"></i> 高斯推断 Gaussian inference</a></div><div class="post-nav-item"><a href="/2020/12/20/transformations/" rel="next" title="各个变换的层次">各个变换的层次 <i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><script>window.addEventListener("tabs:register",()=>{let t=CONFIG.comments["activeClass"];if(CONFIG.comments.storage&&(t=localStorage.getItem("comments_active")||t),t){const e=document.querySelector(`a[href="#comment-${t}"]`);e&&e.click()}}),CONFIG.comments.storage&&window.addEventListener("tabs:click",t=>{t.target.matches(".tabs-comment .tab-content .tab-pane")&&(t=t.target.classList[1],localStorage.setItem("comments_active",t))})</script></div></main><footer class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2021</span> <span class="with-love"><i class="fa fa-heart"></i> </span><span class="author" itemprop="copyrightHolder">Elkulas Jiang</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动</div></div></footer><script src="//cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script><script src="//cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script>if("undefined"==typeof MathJax){window.MathJax={tex:{inlineMath:{"[+]":[["$","$"]]},tags:"none"},options:{renderActions:{insertedScript:[200,()=>{document.querySelectorAll("mjx-container").forEach(e=>{const t=e.parentNode;"li"===t.nodeName.toLowerCase()&&t.parentNode.classList.add("has-jax")})},"",!1]}}};const a=document.createElement("script");a.src="//cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js",a.defer=!0,document.head.appendChild(a)}else MathJax.startup.document.state(0),MathJax.typesetClear(),MathJax.texReset(),MathJax.typeset()</script></body></html>